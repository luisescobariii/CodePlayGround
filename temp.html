<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <?!= include('spectre'); ?>
    <?!= include('style'); ?>
    <?!= include('utils'); ?>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.2/css/all.min.css" />    
</head>
<body>
    
    <div class="container">
        
        <div class="columns">
            <div class="column col-4 col-md-12">
                <div class="panel full-height bg-secondary" id="server-panel">
                    <div class="panel-header"><div class="panel-title">
                        <h3>Databases
                            <div class="btn-group float-right d-none">
                                <button class="btn" title="Add Database" onclick="createDatabase()">
                                    <i class="fas fa-database mr-1"></i><i class="fas fa-plus"></i>
                                </button>
                                <button class="btn btn-action" title="Open Server Spreadsheet" onclick="openServerFile()">
                                    <i class="fas fa-server"></i>
                                </button>
                            </div>
                        </h3>
                    </div>
                </div>
                <div class="panel-body"><div id="db-tree">
                    <span class="loading mr-2"></span>
                    <span class="text-cetner ml-2">Loading server...</span>
                </div></div>
                <div class="panel-footer"></div>
            </div>
        </div>    
        
        <div class="column col-8 col-md-12">
            
            <div class="panel toggable full-height d-none" id="query-panel">
                <div class="panel-header">
                    <a onclick="hidePanel()" class="btn btn-clear float-right" aria-label="Close"></a>
                    <div class="panel-title">
                        <h3>Query</h3>
                    </div>
                </div>
                <div class="panel-body">
                    <div id="out-query">
                        <div class="empty">
                            <div class="empty-icon">
                                <i class="icon fa fa-align-left fa-3x"></i>
                            </div>
                            <p class="empty-title h5">No query selected</p>
                            <p class="empty-subtitle">Selected queries will appear here</p>
                        </div>
                    </div>
                </div>
                <div class="panel-footer"></div>
            </div>
            
            <div class="panel toggable full-height d-none" id="database-panel">
                <div class="panel-header">
                    <a onclick="hidePanel()" class="btn btn-clear float-right" aria-label="Close"></a>
                    <div class="panel-title">
                        <h3>Edit Database - Database Name</h3>
                    </div>
                </div>
                <div class="panel-body">
                    <div id="out-query">
                        <div class="empty">
                            <div class="empty-icon">
                                <i class="icon fa fa-align-left fa-3x"></i>
                            </div>
                            <p class="empty-title h5">No query selected</p>
                            <p class="empty-subtitle">Selected queries will appear here</p>
                        </div>
                    </div>
                </div>
                <div class="panel-footer"></div>
            </div>
            
            <div class="panel toggable full-height d-none" id="edit-panel">
                <div class="panel-header">
                    <a onclick="hidePanel()" class="btn btn-clear float-right" aria-label="Close"></a>
                    <div class="panel-title h3">Edit Table - TableName</div>
                </div>
                <div class="panel-body">
                    
                    <div class="form-group">
                        <label for="inTableName" class="form-label">Name</label>
                        <input id="inTableName" type="text" class="form-input" >
                    </div>
                    
                    <div class="form-group">
                        <label class="form-switch">
                            <input id="inTableLogical" type="checkbox" onchange="showLogicalColumns()">
                            <i class="form-icon"></i> Soft/Logical deletion
                        </label>
                    </div>
                    
                    <br>
                    
                    <h5>Columns
                        <div class="btn-group float-right">
                            <button class="btn btn-action btn-sm" onclick="addEditRow()" title="Add Column"><i class="icon fa fa-plus"></i></button>
                            <button class="btn btn-action btn-sm" onclick="removeEditRow()" title="Remove Column"><i class="icon fa fa-minus"></i></button>
                        </div>
                    </h5>
                    <table class="table">
                        <thead>
                            <tr>
                                <th class="text-center" title="Primary Key"><i class="fa fa-key"></i></th>
                                <th class="col-3">Column Name</th>
                                <th class="col-2">Data Type</th>
                                <th class="col-1 text-center">Size</th>
                                <th class="text-center" title="Allow Nulls">Null</th>
                                <th class="col-3">Foreign Table</th>
                                <th class="col-3">Foreign Key</th>
                            </tr>
                        </thead>
                        <tbody id="table-editor"></tbody>
                        <tfoot id="table-logical-columns"></tfoot>
                    </table>
                </div>
                <div class="panel-footer">
                    <button class="btn btn-link" onclick="hidePanel()">CANCEL</button>
                    <button class="btn btn-primary" onclick="updateTable()">SAVE</button>
                </div>
            </div>
            
        </div>
        
    </div>
    
    
    
</div>

<script>    
    var server, support = [];
    
    (() => {
        google.script.run
        .withSuccessHandler(load)
        .withFailureHandler(console.error)
        .getServer();
    })();
    
    async function load(json) {
        if (json == '') {
            document.querySelector('#db-tree').innerHTML = 
            `<div class="empty">
                <div class="empty-icon">
                    <i class="fa fa-server fa-3x"></i>
                </div>
                <p class="empty-title h5">Create your server to get started</p>
                <p class="empty-subtitle">Your server spreadsheet will be placed in your GDrive's root and named "MSSQL Tools Server"</p>
                <div class="empty-action">
                    <button class="btn btn-primary btn-lg" onclick="createServerFile()">CREATE SERVER</button>
                </div>
            </div>`;
            return;
        }        
        server = JSON.parse(json);
        document.querySelector('#server-panel .panel-title .btn-group').classList.remove('d-none');
        
        if (server.databases.length == 0) {
            document.querySelector('#db-tree').innerHTML = 
            `<div class="empty">
                <div class="empty-icon">
                    <i class="fa fa-database fa-3x"></i>
                </div>
                <p class="empty-title h5">There are no databases</p>
                <p class="empty-subtitle">To create a database click the <span class="chip" title="Add Database"><i class="fas fa-database mr-1"></i><i class="fas fa-plus"></i></span> button</p>
            </div>`;
            return;
        }     
        
        google.script.run
        .withSuccessHandler(loadSupport)
        .withFailureHandler(console.error)
        .getSupport();
        
        loadDbTree();
    }
    
    async function loadSupport(json) {
        support = JSON.parse(json);
    }
    
    async function openServerFile() {
        window.open(server.url, '_blank');
    }
    
    async function createServerFile() {
        document.querySelector('#db-tree .btn-primary').classList.add('loading');
        google.script.run
        .withSuccessHandler(load)
        .withFailureHandler(console.error)
        .createServerFile();
    }
    
    async function loadDbTree() {
        databases = server.databases.sort((a,b) => a.name > b.name ? 1 : -1);
        let html = '',dCounter = 0, tCounter = 0, cCounter = 0;;
        for (let db of databases) {                
            let tables = ''
            db.tables = db.tables.sort((a,b) => a.name > b.name ? 1 : -1);
            for (let table of db.tables) {
                let columns = '<ul>';
                    for (let column of table.columns) {                            
                        let icon = column.identity ? 'key primary' : 'columns';
                        let size = column.size ? `(${column.size})` : '';
                        let nul = column.nullable ? 'null' : 'not null';
                        let foreign = '';
                        if (column.foreignKey) {
                            icon = 'key';
                            foreign = `<span class="text-gray"> (${column.foreignTable}.${column.foreignKey})</span>`;
                        }
                        
                        columns += `<li><i class="fa fa-${icon} mr-1"></i>${column.name} <small>(${column.dataType}${size}, ${nul})${foreign}</small></li>`;
                    }
                    columns += '</ul>';
                    
                    tables += 
                    `<div class="accordion">
                        <input type="checkbox" id="accordion-table-${tCounter}" name="accordion-checkbox" hidden>
                        <label class="accordion-header hoverable" for="accordion-table-${tCounter++}">
                            <i class="icon fa fa-chevron-right mr-1"></i>
                            <i class="fa fa-table mr-1"></i>${table.name}
                            <button class="btn btn-sm btn-action btn-link options-button" title="Edit Table ${table.name}" onclick="editTable('${db.name}','${table.name}')">
                                <i class="fa fa-edit"></i>
                            </button>
                        </label>
                        <div class="accordion-body">
                            ${columns}
                        </div>
                    </div>`;
                }
                
                html = 
                `<div class="accordion">
                    <input type="checkbox" id="accordion-db-${dCounter}" name="accordion-checkbox" hidden>
                    <label class="accordion-header hoverable" for="accordion-db-${dCounter++}">
                        <i class="icon fa fa-chevron-right mr-1"></i>
                        <i class="fa fa-database mr-1"></i>${db.name}
                        <div class="dropdown dropdown-right options-button">
                            <button class="btn btn-sm btn-action btn-link dropdown-toggle" tabindex="0">
                                <i class="fa fa-ellipsis-v"></i>
                            </button>                                
                            <ul class="menu">
                                <li class="menu-item"><button onclick="editDatabase('${db.name}')">Edit Database</button></li>
                                <li class="menu-item"><button onclick="createTables('${db.name}')">Tables Query</button></li>
                                <li class="menu-item"><button>Procedures Query</button></li>
                            </ul>
                        </div>
                    </label>
                    <div class="accordion-body">
                        ${tables}
                    </div>
                </div>`;
            }
            
            document.querySelector('#db-tree').innerHTML = html;
        }
        
        async function createTable(dbName) {      
            let db = server.databases.find(d => d.name == dbName);
            let table = { columns:[null,null,null,null] };
            showEditPanel(db, table);
        }
        
        async function editTable(dbName, tableName) {      
            let db = server.databases.find(d => d.name == dbName);
            let table = db.tables.find(t => t.name == tableName);
            showEditPanel(db, table);
        }
        
        async function showEditPanel(db, table) {
            support.editDb = db;
            support.editRowCount = 0;
            let rows = '';
            for (let column of table.columns) { rows += await getTableEditRow(column); }            
            document.querySelector('#table-editor').innerHTML = rows;
            document.querySelector('#edit-panel .panel-title').innerHTML = table.name ? 'Edit Table: ' + table.name : 'Add Table';
            document.querySelector('#edit-panel').classList.remove('d-none');
        }

        async function updateTable() {
            console.log(1);
            console.log(databases, support);
        }
        
        async function getTableEditRow(column, disabled = false) {
            if (!column) { column = {identity:false, name:'', size: '', foreignTable:'', foreignKey:''}; }            
            let rowId = support.editRowCount++;
            let checkId = column.identity ? 'checked' : ''; 
            let checkNull = column.nullable ? 'checked' : '';
            let dis = disabled ? 'disabled' : '';
            let size = column.size ? column.size : '';
            
            let dataTypeGroups = [...new Set(support.dataTypes.map(dt => dt.group))];
            let dataTypeOptions = '';
            
            for (let group of dataTypeGroups) {
                let filtered = support.dataTypes.filter(dt => dt.group == group);
                dataTypeOptions += `<optgroup label="${group}">`;
                    for (let dataType of filtered) {
                        let sel = dataType.name == column.dataType ? 'selected' : '';
                        dataTypeOptions += `<option ${sel}>${dataType.name}</option>`;
                    }
                    dataTypeGroups += `</optgroup>`;
                }
                
                let tableOptions = support.editDb.tables.map(t => {
                    let sel = t.name == column.foreignTable ? 'selected' : '';
                    return `<option ${sel}>${t.name}</option>`;
                }).join('');
                
                let keyOptions = '';
                if (column.foreignKey) {
                    let table = support.editDb.tables.find(t => t.name == column.foreignTable);
                    if (table) {
                        keyOptions = table.columns.map(c => {
                            let sel = c.name == column.foreignKey ? 'selected' : '';
                            return `<option ${sel}>${c.name}</option>`;
                        }).join('');
                    }
                }
                
                return `<tr data-id="${rowId}">
                    <td>
                        <label class="form-radio centered">
                            <input type="radio" name="identity" ${checkId} class="inIdentity" ${dis}>
                            <i class="form-icon"></i>
                        </label>
                    </td>
                    <td>
                        <input type="text" class="form-input inName" value="${column.name}"  ${dis}/>
                    </td>
                    <td>
                        <select class="form-select inDataType" value="${column.dataType}" ${dis}>
                            <option></option>${dataTypeOptions}
                        </select>
                    </td>
                    <td>
                        <input type="text" class="form-input text-center inSize" value="${column.size}" ${dis} />
                    </td>
                    <td>
                        <label class="form-checkbox centered">
                            <input type="checkbox" ${checkNull} class="inNullable" ${dis}>
                            <i class="form-icon"></i>
                        </label>
                    </td>
                    <td>
                        <select class="form-select inForeignTable" value="${column.foreignTable}" onchange="filterForeignKeyOptions(${rowId})" ${dis}>
                            <option></option>${tableOptions}
                        </select>
                    </td>
                    <td>
                        <select class="form-select inForeignKey" value="${column.foreignKey}" ${dis}>
                            <option></option>${keyOptions}
                        </select>
                    </td>
                </tr>`;
            }
            
            async function showLogicalColumns() {
                let logical = document.querySelector('#inTableLogical').checked;
                let html = '';
                if (logical) {
                    support.editDb = {tables: [{name: 'Users', columns:[{name:'Id'}]}]};
                    html += await getTableEditRow({identity:false, name:'Active', dataType:'bit', size: '', nullable: false, foreignTable: '', foreignKey: ''}, true);
                    html += await getTableEditRow({identity:false, name:'Created', dataType:'datetime', size: '', nullable: false, foreignTable: '', foreignKey: ''}, true);
                    html += await getTableEditRow({identity:false, name:'Creator', dataType:'int', size: '', nullable: false, foreignTable: 'Users', foreignKey: 'Id'}, true);
                    html += await getTableEditRow({identity:false, name:'Updated', dataType:'datetime', size: '', nullable: false, foreignTable: '', foreignKey: ''}, true);
                    html += await getTableEditRow({identity:false, name:'Updator', dataType:'int', size: '', nullable: false, foreignTable: 'Users', foreignKey: 'Id'}, true);
                }
                document.querySelector('#table-logical-columns').innerHTML = html;
            }
            
            async function addEditRow() {
                document.getElementById('table-editor').insertAdjacentHTML('beforeend', await getTableEditRow());
            }
            
            async function removeEditRow() {
                let logical = document.querySelector('#inTableLogical').checked;                
                let table = document.getElementById('table-editor').parentElement;
                let count = table.rows.length;
                let min = 2, pos = count - 1;
                if (logical) { min = 7; pos = count - 6; }
                if (count > min) { table.deleteRow(pos); }
            }
            
            async function filterForeignKeyOptions(id) {
                let foreignTableName = document.querySelector(`#table-editor tr[data-id="${id}"] .inForeignTable`).value;
                let options = '<option></option>';;
                if (foreignTableName) {                    
                    let foreignTable = support.editDb.tables.find(t => t.name == foreignTableName);                
                    
                    
                    for (let column of foreignTable.columns) {
                        options += `<option>${column.name}</option>`;
                    }
                }
                document.querySelector(`#table-editor tr[data-id="${id}"] .inForeignKey`).innerHTML = options;
            }
            
            async function hideModal() {
                document.querySelector('.modal.active').classList.remove('active');
            }
            
            async function hidePanel() {
                document.querySelector('.panel.toggable:not(.d-none)').classList.add('d-none');
            }
            
            async function createTables(dbName) {                
                let db = server.databases.find(d => d.name == dbName);
                
                let references = [];
                for (let table of db.tables) {
                    for (let column of table.columns) {
                        if (column.foreignTable) {
                            let reference = `${table.name}/${column.foreignTable}`;
                            if (!references.includes(reference)) { references.push(reference); }
                        }
                    }
                }
                references = references.map(reference => {
                    let parts = reference.split('/');
                    return { source: parts[0], target: parts[1] }
                });
                
                // Check for circular references
                for (let i = 0; i < references.length; i++) {
                    for (let j = 0; j < references.length; j++) {
                        if (j != i) {
                            if (references[j].source == references[i].target && references[j].target == references[i].source) {
                                alert(`Error: Circular reference (${references[i].source}, ${references[i].target}).`);
                                return;
                            }
                        }
                    }
                }
                
                // Add tables without references
                let sorted = [];
                for (let table of db.tables) {
                    let found = references.find(r => r.source == table.name);
                    if (!found) { sorted.push(table); }
                }
                
                // Order tables by reference
                let loopSafe = 10000000;
                while (sorted.length < db.tables.length) {                    
                    for (table of db.tables) {
                        if (sorted.find(t => t.name == table.name)) { continue; }
                        let refs = references.filter(r => r.source == table.name);
                        let ready = true;
                        for (let r of refs) {
                            if (!sorted.find(t => t.name == r.target)) { ready = false; break; }
                        }
                        if (ready) { sorted.push(table); }
                    }
                    if (--loopSafe < 0) { alert('Error: Unable to parse database.'); return; }
                }
                
                let query = '<pre>';
                    
                    for (let table of sorted) {
                        let columns = '';
                        for (let column of table.columns) {
                            let type = column.dataType.toUpperCase();
                            let size = column.size ? `(${column.size.toString().toUpperCase()})` : '';
                            let nul = column.nullable ? 'NULL' : 'NOT NULL';
                            if (column.identity) {
                                nul = 'PRIMARY KEY IDENTITY (1, 1)';
                            }
                            columns += `    ${safe(column.name)} ${type}${size} ${nul},\n`;
                            
                            if (column.foreignKey) {
                                columns += `    FOREIGN KEY (${safe(column.name)}) REFERENCES ${safe(db.name)}.${safe(column.foreignTable)} (${safe(column.foreignKey)}),\n`;
                            }
                        }
                        columns = columns.slice(0, -2);
                        
                        query += `CREATE TABLE ${safe(db.name)}.${safe(table.name)} (\n${columns}\n);\n\n`;
                    }
                    document.querySelector('#out-query').innerHTML = query + '</pre>';
                    document.querySelector('#query-panel').classList.remove('d-none');
                }
                
            </script>
            
        </body>
        </html>